#!/usr/bin/env python

# coding=utf-8
# pylint: disable=broad-except,unused-argument,line-too-long
# Copyright (c) 2016-2018, F5 Networks, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
"""
This module reads f5-declarative-onboarding and f5-appsvcs-3
declarations from userdata.

The module must be enabled in the userdata YAML to perform any
onboarding artifact generation or onboarding.

#cloud-config
tmos_declared:
  enabled: True

This module will also look for YAML metadata which typically
is handled by the cc_ssh.py module:

#cloud-config
ssh_authorized_keys:
  - ssh-rsa [key]
  - ssh-rsa [key]

The standard cloud-init cc_ssh.py module alters SELinux
configurations which may not be compatible with TMOS

Additional attributes supported in the YAML declaration
include

do_declaration - f5-declarative-onboarding declaration.

as3_declaration - the f5-appsvc-3 declaration to apply after onboarding.

#cloud-config
tmos_configdrive_openstack:
  enabled: True
  do_declaration:
    Common:
      class: Tenant
      licenseKey:
        class: License
        licenseType: regKey
        regKey: GJKDM-UJTJH-OJZVX-ZJPEG-XTJIAHI
      provisioningLevels:
        class: Provision
        ltm: nominal
        asm: minimum
  as3_declaration:
    class: AS3
    action: deploy
    persist: true
    declaration:
      class: ADC
      schemaVersion: 3.0.0

"""
import datetime
import logging
import os
import subprocess

from cloudinit import util
from cloudinit import log as logging

import tmos_onboard_utils

LOG = logging.getLogger(__name__)

# constants
OUT_DIR = '/config/cloud/tmos-declared'

PROGRESS_FILE = OUT_DIR + '/cloudinit.log'

AS3_DELAYED_DEPLOYMENT_SCRIPT = 'cc_tmos_as3_declare_after_do.py'


# stanard logging function for this module
def log_progress(message):
    """Generate a progress log entry"""
    if not os.path.isdir(OUT_DIR):
        os.makedirs(OUT_DIR)
    with open(PROGRESS_FILE, 'a+') as progress_file:
        progress_file.write(
            '[' + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S.%m") + '] - ' + message + '\n')
        if __name__ == "__main__":
            print(
                '[' + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S.%m") +
                '] - ' + message
            )


def onboard(do_declaration, as3_declaration):
    """Implements the onboarding business logic"""

    try:
        tmos_onboard_utils.persist_do_declaration(do_declaration, None)
    except Exception as err:
        log_progress(
            'could not persist f5-declarative-onboarding declaration: %s' % err)
        return False

    as3_enabled = True
    if as3_declaration:
        try:
            tmos_onboard_utils.persist_as3_declaration(as3_declaration)
        except Exception as err:
            log_progress('could not persist f5-appsvcs-3 declaration %s' % err)
            as3_enabled = False
    else:
        as3_enabled = False

    log_progress('installing discovered iControlLX extensions')
    tmos_onboard_utils.install_extensions(log_progress)

    tmos_onboard_utils.wait_for_icontrollx()
    if not tmos_onboard_utils.do_declare():
        log_progress('f5-declarative-onboarding initial post failed')
        return False
    if as3_enabled:
        deploy_script_name = os.path.dirname(
            os.path.realpath(__file__)) + AS3_DELAYED_DEPLOYMENT_SCRIPT
        log_progress('running f5-appsrvs-3 delayed deployment script')
        deploy_cmd = '/usr/bin/env python %s' % deploy_script_name
        subprocess.call(['nohup', 'sh', '-c', deploy_cmd, '&'])
        injected_already = subprocess.Popen(
            "cat /config/startup | grep " + AS3_DELAYED_DEPLOYMENT_SCRIPT + " | wc -l",
            stdout=subprocess.PIPE, shell=True
        ).communicate()[0].replace('\n', '')
        if injected_already == '0':
            with open('/config/startup', 'a+') as css:
                css.write('/usr/bin/env python %s &' % deploy_script_name)
    log_progress('onboarding complete')
    return True


def handle(name, cloud_config, cloud, log, args):
    """Cloud-init processing function"""
    tag = 'tmos_declared'
    enabled = False
    do_declaration = None
    if tag in cloud_config:
        try:
            enabled = bool(cloud_config[tag]['enabled'])
            do_declaration = cloud_config[tag]['do_declaration']
        except Exception:
            util.logexc(
                log, tag + " missing enabled or do_declaration attributes")
            return
    if enabled and do_declaration:
        keys = []
        if "ssh_authorized_keys" in cloud_config:
            cfgkeys = cloud_config["ssh_authorized_keys"]
            keys.extend(cfgkeys)
        icontrollx_package_urls = []
        if 'icontrollx_package_urls' in cloud_config[tag]:
            icontrollx_package_urls = cloud_config[tag]['icontrollx_package_urls']
        as3_declaration = None
        if 'as3_declaration' in cloud_config[tag]:
            as3_declaration = cloud_config[tag]['as3_declaration']

        tmos_onboard_utils.inject_public_ssh_keys(keys)
        for ext_url in icontrollx_package_urls:
            try:
                tmos_onboard_utils.download_extension(ext_url)
            except Exception as err:
                util.logexc(log, "can't download %s - %s" % (ext_url, err))

        try:
            onboard(do_declaration, as3_declaration)
        except Exception as err:
            util.logexc(log, "onboard exception - %s" % err)
        tmos_onboard_utils.clean()


if __name__ == "__main__":
    # Running the cloud-init module from the CLI python interpreter
    CLOUD_CONFIG_FILE = '/opt/cloud/instance/cloud-config.txt'
    CLOUD_CONFIG = {
        'tmos_declared': {
            'enabled': True,
            'do_declaration': {},
            'as3_declaration': {}
        }
    }
    if os.path.exists(CLOUD_CONFIG_FILE):
        CLOUD_CONFIG = util.read_conf(CLOUD_CONFIG_FILE)
    handle('cc_tmos_declared',
           CLOUD_CONFIG, None, logging, [])
