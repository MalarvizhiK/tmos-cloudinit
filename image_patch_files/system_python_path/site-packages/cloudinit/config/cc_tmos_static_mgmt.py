#!/usr/bin/env python

# coding=utf-8
# Copyright (c) 2016-2018, F5 Networks, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

"""
This module enables the TMOS mgmt interface to be provisioned
statically through cloudinit userdata.

The module must be enabled in the userdata YAML to perform any
onboarding artifact generation or onboarding.

#cloud-config
tmos_satic_mgmt:
  enabled: True
  ip: 192.168.245.100/24
  gw: 192.168.245.1
  mtu: 1450

"""
import os
import sys
import datetime
import subprocess

from cloudinit import util
from cloudinit import log as logging

LOG = logging.getLogger(__name__)

OUT_DIR = '/config/cloud/tmos_static_mgmt'

PROGRESS_FILE = OUT_DIR + '/cloudinit.log'

TMSH_CMD_FILE_DIR = OUT_DIR + '/initscripts'


def tmsh_cmd_dir_exists():
    """Ensures TMSH generated init script directory exists"""
    if not os.path.isdir(TMSH_CMD_FILE_DIR):
        os.makedirs(TMSH_CMD_FILE_DIR)


def log_progress(message):
    """Generate a progress log entry"""
    if not os.path.isdir(OUT_DIR):
        os.makedirs(OUT_DIR)
    with open(PROGRESS_FILE, 'a+') as progress_file:
        progress_file.write(
            '[' + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S.%m") + '] - ' + message + '\n')
        if __name__ == "__main__":
            print(
                '[' + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S.%m") +
                '] - ' + message
            )


def is_mcpd():
    """Determines if the TMOS master control process is running"""
    log_progress('checking mcpd run state')
    running = subprocess.Popen(
        "tmsh -a show sys mcp-state field-fmt | grep running | wc -l",
        stdout=subprocess.PIPE, shell=True
    ).communicate()[0].replace('\n', '')
    if int(running) == 1:
        log_progress('mcpd is running')
        return True
    log_progress('mcpd is not running')
    return False


def is_onenic():
    """Determines if the TMOS deployment is a 1NIC deployment"""
    log_progress('testing is 1NIC deployment')
    if is_mcpd():
        fnull = open(os.devnull, 'w')
        is_1nic = subprocess.call(
            ['/usr/bin/tmsh', 'list', 'net', 'interface', '1.0'], stdout=fnull, stderr=fnull)
        if is_1nic == 0:
            log_progress('1NIC deployment detected from tmsh')
            return True
        log_progress('tmsh did not see interface 1.0, not 1NIC')
        return False
    else:
        log_progress('enumerating linux ip link devices')
        interfaces = subprocess.Popen(
            "ip link | egrep 'eth[1-9]' | cut -d':' -f2 | tr -d ' '",
            stdout=subprocess.PIPE, shell=True
        ).communicate()[0].split('\n')
        if 'eth1' in interfaces:
            log_progress('linux ip saw multiple interfaces, not 1NIC')
            return False
        log_progress('1NIC deployment detected from linux ip link')
        return True


def create_onboard_artifacts(mgmt_cidr, mgmt_gw, mgmt_mtu):
    """Generates all needed onboarding artifacts from metadata"""
    tmsh_cmd_dir_exists()
    network_onboard_script = TMSH_CMD_FILE_DIR + '/001_mgmt_setup.sh'
    if os.path.isfile(network_onboard_script):
        util.del_file(network_onboard_script)
    with open(network_onboard_script, 'w') as mgmt_script:
        mgmt_script.write("#!/bin/bash\n")
        mgmt_script.write("echo 'starting static mgmt network provisioning'\n")
        mgmt_script.write(
            "tmsh modify sys global-settings mgmt-dhcp disabled\n")
        onenic = is_onenic()
        if onenic:
            mgmt_script.write("echo '1 NIC deployment discovered'\n")
            mgmt_script.write("tmsh modify sys httpd ssl-port 8443\n")
            mgmt_script.write(
                "tmsh modify net self-allow defaults add { tcp:8443 }\n")
            mgmt_script.write("tmsh create sys management-ip %s\n" % mgmt_cidr)
            mgmt_script.write(
                "tmsh modify sys management-ip %s description 'provisioned by tmos_static_mgmt'\n" % mgmt_cidr)
            if mgmt_mtu:
                mgmt_script.write(
                    "tmsh create net vlan internal { interfaces replace-all-with { 1.0 { } } tag 4094 mtu %s }\n" % mgmt_mtu)
            else:
                mgmt_script.write(
                    "tmsh create net vlan internal { interfaces replace-all-with { 1.0 { } } tag 4094 }\n")
            mgmt_script.write(
                "tmsh create net self self_1nic { address %s allow-service default vlan internal }\n" % mgmt_cidr)
            if mgmt_gw:
                mgmt_script.write(
                    "tmsh create sys management-route default gateway %s\n" % mgmt_gw)
                mgmt_script.write(
                    "tmsh create net route default network default gw %s\n" % mgmt_gw)
        else:
            mgmt_script.write("sleep 5\n")
            mgmt_script.write("tmsh create sys management-ip %s\n" % mgmt_cidr)
            mgmt_script.write(
                "tmsh modify sys management-ip %s description 'provisioned by tmos_static_mgmt'\n" % mgmt_cidr)
            if mgmt_gw:
                mgmt_script.write(
                    "tmsh create sys management-route default gateway %s\n" % mgmt_gw)
            if mgmt_mtu:
                mgmt_script.write("ip link set mgmt mtu %s\n" % mgmt_mtu)
                mgmt_script.write(
                    "echo 'ip link set mgmt mtu %s' > /config/startup\n" % mgmt_mtu)
        mgmt_script.write("echo 'mgmt interface configured: %s'\n" % mgmt_cidr)
        mgmt_script.write("tmsh save sys config base\n")


def onboard():
    """Implements the onboarding business logic"""
    onboard_script = TMSH_CMD_FILE_DIR + '/onboard.sh'
    if os.path.isfile(onboard_script):
        util.del_file(onboard_script)
    script_files = os.listdir(TMSH_CMD_FILE_DIR)
    script_files.sort()
    with open(onboard_script, 'w') as obs:
        obs.write("#!/bin/bash\n\n")
        obs.write("function check_mcpd_up() {\n")
        obs.write("    checks=0\n")
        obs.write("    while [ $checks -lt 120 ]; do\n")
        obs.write(
            "        if tmsh -a show sys mcp-state field-fmt 2> /dev/null | grep -q running; then\n")
        obs.write("            break\n")
        obs.write("        fi\n")
        obs.write("        echo 'waiting for mcpd to reach running state'\n")
        obs.write("        let checks=checks+1\n")
        obs.write("        sleep 10\n")
        obs.write("    done\n")
        obs.write("}\n\n")
        obs.write("function exec_phases() {\n")
        for script_file in script_files:
            obs.write("    /bin/bash %s/%s\n" %
                      (TMSH_CMD_FILE_DIR, script_file))
        obs.write("}\n\n")
        obs.write("check_mcpd_up\n")
        obs.write("exec_phases\n")
    os.chmod(onboard_script, 0775)
    with open('/var/log/onboard.log', 'a+') as onboardlog:
        subprocess.call(['nohup', 'sh', '-c', onboard_script,
                         '&'], stdout=onboardlog, stderr=onboardlog)


def handle(name, cloud_config, cloud, log, args):
    """Cloud-init processing function"""
    mgmt_cidr = None
    mgmt_gw = None
    mgmt_mtu = 1500
    if 'tmos_static_mgmt' in cloud_config:
        try:
            mgmt_cidr = cloud_config['tmos_static_mgmt']['ip']
            if 'gw' in cloud_config['tmos_static_mgmt']:
                mgmt_gw = cloud_config['tmos_static_mgmt']['gw']
            if 'mtu' in cloud_config['tmos_static_mgmt']:
                mgmt_mtu = cloud_config['tmos_static_mgmt']['mtu']
        except Exception:
            util.logexc(log, "tmos_static_mgmt missing ip or gw attribute")
            return
        create_onboard_artifacts(mgmt_cidr, mgmt_gw, mgmt_mtu)
        onboard()


if __name__ == "__main__":
    # Running the cloud-init module from the CLI python interpreter
    CLOUD_CONFIG_FILE = '/opt/cloud/instance/cloud-config.txt'
    CLOUD_CONFIG = {
        'tmos_static_mgmt': {
            'enabled': True,
            'ip': sys.argv[1],
            'gw': sys.argv[2],
            'mtu': sys.argv[3]
        }
    }
    if os.path.exists(CLOUD_CONFIG_FILE):
        CLOUD_CONFIG = util.read_conf(CLOUD_CONFIG_FILE)
    handle('cc_tmos_static_mgmt', CLOUD_CONFIG, None, logging, [])
